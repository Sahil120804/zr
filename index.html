<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZestRewards - Point Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
        }

        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover:not(.active) {
            background: #e8e8e8;
        }

        .content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 40px;
            margin-bottom: 10px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input::placeholder {
            color: #999;
        }

        .input-hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #e0e0e0;
            color: #333;
        }

        button.secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid #c33;
            display: none;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid #3c3;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: #f5f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #555;
            margin-top: 20px;
        }

        .info-box strong {
            color: #667eea;
        }

        .points-display {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            display: none;
        }

        .balance-box {
            background: #e8f5e9;
            padding: 16px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            border-left: 4px solid #4caf50;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: 700;
            color: #2e7d32;
        }

        .balance-label {
            font-size: 13px;
            color: #555;
            margin-top: 4px;
        }

        .button-row {
            display: flex;
            gap: 10px;
        }

        .button-row button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="add">‚ûï Add Points</button>
            <button class="tab" data-tab="redeem">üéÅ Redeem Points</button>
        </div>

        <div class="content">
            <!-- Add Points Tab -->
            <div class="tab-content active" id="add-tab">
                <div class="header">
                    <div class="logo">üéä</div>
                    <h1>Add Points</h1>
                    <p class="subtitle">Create new transaction and add points</p>
                </div>

                <div class="error" id="errorMsg1"></div>
                <div class="success" id="successMsg1"></div>

                <form id="transactionForm">
                    <div class="form-group">
                        <label for="phone1">Phone Number *</label>
                        <input 
                            type="tel" 
                            id="phone1" 
                            placeholder="919876543210"
                            required
                        >
                        <div class="input-hint">Enter phone with country code</div>
                    </div>

                    <div class="form-group">
                        <label for="name1">Customer Name (Optional)</label>
                        <input 
                            type="text" 
                            id="name1" 
                            placeholder="e.g., Rahul Kumar"
                        >
                    </div>

                    <div class="form-group">
                        <label for="bill1">Bill Amount (‚Çπ) *</label>
                        <input 
                            type="number" 
                            id="bill1" 
                            placeholder="500"
                            min="1"
                            step="0.01"
                            required
                        >
                        <div class="input-hint">Enter amount in rupees</div>
                        <div class="points-display" id="pointsDisplay1"></div>
                    </div>

                    <button type="submit">Create Transaction</button>
                    <div class="loading" id="loading1">
                        <span class="spinner"></span>Processing...
                    </div>
                </form>

                <div class="info-box">
                    <strong>Info:</strong><br>
                    Customer will receive WhatsApp notification with points added.
                </div>
            </div>

            <!-- Redeem Points Tab -->
            <div class="tab-content" id="redeem-tab">
                <div class="header">
                    <div class="logo">üéÅ</div>
                    <h1>Redeem Points</h1>
                    <p class="subtitle">Check balance and redeem customer points</p>
                </div>

                <div class="error" id="errorMsg2"></div>
                <div class="success" id="successMsg2"></div>

                <div class="form-group">
                    <label for="phone2">Phone Number *</label>
                    <input 
                        type="tel" 
                        id="phone2" 
                        placeholder="919876543210"
                        required
                    >
                    <div class="input-hint">Enter phone with country code</div>
                </div>

                <div class="button-row">
                    <button id="checkBtn">Check Balance</button>
                    <button id="clearBtn" class="secondary">Clear</button>
                </div>

                <div id="balanceSection" style="display:none">
                    <div class="balance-box">
                        <div class="balance-amount" id="balanceAmount">0</div>
                        <div class="balance-label">Available Points</div>
                    </div>

                    <div class="form-group">
                        <label for="points2">Points to Redeem *</label>
                        <input 
                            type="number" 
                            id="points2" 
                            placeholder="Enter points (e.g., 100)"
                            min="1"
                        >
                    </div>

                    <div class="form-group">
                        <label for="rewardDesc">Reward Description (Optional)</label>
                        <input 
                            type="text" 
                            id="rewardDesc" 
                            placeholder="e.g., ‚Çπ100 discount at billing"
                        >
                    </div>

                    <button id="redeemBtn">Redeem Points</button>
                    <div class="loading" id="loading2">
                        <span class="spinner"></span>Processing...
                    </div>
                </div>

                <div class="info-box">
                    <strong>Tip:</strong> 1 point = ‚Çπ1. If customer doesn't exist, create transaction first in Add Points tab.
                </div>
            </div>
        </div>
    </div>

    <script>
        const RESTAURANT_ID = "rest_001";
        const POINTS_RATE = 10;
        const BACKEND_URL = "https://zr-q3p2.onrender.com";

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                
                hideAllMessages();
            });
        });

        // Helper functions
        function showError(msgId, text) {
            const el = document.getElementById(msgId);
            el.textContent = text;
            el.style.display = 'block';
            document.getElementById(msgId.replace('errorMsg', 'successMsg')).style.display = 'none';
        }

        function showSuccess(msgId, text) {
            const el = document.getElementById(msgId);
            el.textContent = text;
            el.style.display = 'block';
            document.getElementById(msgId.replace('successMsg', 'errorMsg')).style.display = 'none';
        }

        function hideMessages(errorId, successId) {
            document.getElementById(errorId).style.display = 'none';
            document.getElementById(successId).style.display = 'none';
        }

        function hideAllMessages() {
            hideMessages('errorMsg1', 'successMsg1');
            hideMessages('errorMsg2', 'successMsg2');
        }

        function cleanPhone(phone) {
            if (!phone) return null;
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) return '91' + digits;
            if (digits.length === 12 && digits.startsWith('91')) return digits;
            if (digits.length > 10) return digits;
            return null;
        }

        // ========================================
        // ADD POINTS TAB
        // ========================================
        
        const form1 = document.getElementById('transactionForm');
        const phone1 = document.getElementById('phone1');
        const name1 = document.getElementById('name1');
        const bill1 = document.getElementById('bill1');
        const pointsDisplay1 = document.getElementById('pointsDisplay1');
        const loading1 = document.getElementById('loading1');

        bill1.addEventListener('input', (e) => {
            const bill = parseFloat(e.target.value);
            if (bill && bill > 0) {
                const points = Math.floor(bill / POINTS_RATE);
                pointsDisplay1.textContent = 'üí∞ Points Earned: ' + points + ' points';
                pointsDisplay1.style.display = 'block';
            } else {
                pointsDisplay1.style.display = 'none';
            }
        });

        form1.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages('errorMsg1', 'successMsg1');

            const phone = cleanPhone(phone1.value.trim());
            const name = name1.value.trim();
            const bill = parseFloat(bill1.value);

            if (!phone) {
                showError('errorMsg1', 'Please enter a valid phone number');
                return;
            }

            if (bill < 1) {
                showError('errorMsg1', 'Bill amount must be at least ‚Çπ1');
                return;
            }

            loading1.style.display = 'block';
            const submitBtn = form1.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            try {
                const pointsEarned = Math.floor(bill / POINTS_RATE);
                const transactionId = 'txn_' + phone + '_' + Math.floor(Date.now() / 1000);

                const response = await fetch(BACKEND_URL + '/create-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_id: transactionId,
                        customer_phone: phone,
                        customer_name: name || "",
                        restaurant_id: RESTAURANT_ID,
                        bill_amount: bill,
                        points_earned: pointsEarned,
                        added_by: "frontend",
                        notes: ""
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const customerName = name || phone;
                    showSuccess('successMsg1', `‚úÖ Transaction created! ${pointsEarned} points added for ${customerName}`);
                    form1.reset();
                    pointsDisplay1.style.display = 'none';
                } else {
                    showError('errorMsg1', data.error || 'Failed to create transaction');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('errorMsg1', 'Network error. Please check connection.');
            } finally {
                loading1.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Auto-format phone
        phone1.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 12) value = value.slice(0, 12);
            e.target.value = value;
        });

        // ========================================
        // REDEEM POINTS TAB
        // ========================================
        
        const phone2 = document.getElementById('phone2');
        const points2 = document.getElementById('points2');
        const rewardDesc = document.getElementById('rewardDesc');
        const balanceSection = document.getElementById('balanceSection');
        const balanceAmount = document.getElementById('balanceAmount');
        const loading2 = document.getElementById('loading2');
        const checkBtn = document.getElementById('checkBtn');
        const clearBtn = document.getElementById('clearBtn');
        const redeemBtn = document.getElementById('redeemBtn');

        let currentCustomer = null;

        phone2.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 12) value = value.slice(0, 12);
            e.target.value = value;
        });

        clearBtn.addEventListener('click', () => {
            hideMessages('errorMsg2', 'successMsg2');
            phone2.value = '';
            points2.value = '';
            rewardDesc.value = '';
            balanceSection.style.display = 'none';
            currentCustomer = null;
        });

        checkBtn.addEventListener('click', async () => {
            hideMessages('errorMsg2', 'successMsg2');
            
            const phone = cleanPhone(phone2.value.trim());
            if (!phone) {
                showError('errorMsg2', 'Please enter a valid phone number');
                return;
            }

            checkBtn.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/check-balance?phone=${encodeURIComponent(phone)}`);
                const data = await response.json();

                if (!response.ok) {
                    showError('errorMsg2', data.error || 'Error checking balance');
                    return;
                }

                if (!data.found) {
                    showError('errorMsg2', 'Customer not found. Create a transaction first in Add Points tab.');
                    return;
                }

                const customer = data.customer;
                const balance = customer.points_balance || 0;
                
                currentCustomer = { phone, balance };
                balanceAmount.textContent = balance;
                balanceSection.style.display = 'block';
                
                showSuccess('successMsg2', '‚úÖ Balance loaded successfully');
            } catch (error) {
                console.error('Error:', error);
                showError('errorMsg2', 'Network error while checking balance');
            } finally {
                checkBtn.disabled = false;
            }
        });

        redeemBtn.addEventListener('click', async () => {
            hideMessages('errorMsg2', 'successMsg2');

            if (!currentCustomer) {
                showError('errorMsg2', 'Please check balance first');
                return;
            }

            const pointsToRedeem = parseInt(points2.value || '0', 10);
            
            if (!pointsToRedeem || pointsToRedeem <= 0) {
                showError('errorMsg2', 'Please enter a valid points amount');
                return;
            }

            if (pointsToRedeem > currentCustomer.balance) {
                showError('errorMsg2', 'Insufficient points. Available: ' + currentCustomer.balance);
                return;
            }

            loading2.style.display = 'block';
            redeemBtn.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/redeem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_phone: currentCustomer.phone,
                        points_to_redeem: pointsToRedeem,
                        reward_name: "Points Redemption",
                        reward_description: rewardDesc.value.trim() || "Redeemed loyalty points",
                        redeemed_by: "frontend"
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showError('errorMsg2', data.error || 'Redeem failed');
                    return;
                }

                showSuccess('successMsg2', `‚úÖ Redeemed ${pointsToRedeem} points! New balance: ${data.new_balance}. ID: ${data.redemption_id}`);
                
                currentCustomer.balance = data.new_balance;
                balanceAmount.textContent = data.new_balance;
                points2.value = '';
                rewardDesc.value = '';
            } catch (error) {
                console.error('Error:', error);
                showError('errorMsg2', 'Network error while redeeming');
            } finally {
                loading2.style.display = 'none';
                redeemBtn.disabled = false;
            }
        });
    </script>
</body>
</html>